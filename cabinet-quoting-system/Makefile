# Cabinet Quoting System - Docker Management Makefile
# Following 2025 DevOps best practices for container orchestration

.PHONY: help build up down restart logs status health clean prune backup restore

# Default target
help: ## Show this help message
	@echo "Cabinet Quoting System - Docker Management Commands"
	@echo "=================================================="
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

# Development commands
dev-up: ## Start all services in development mode
	@echo "ğŸš€ Starting Cabinet Quoting System in development mode..."
	docker-compose up -d
	@echo "âœ… All services started! Check status with: make status"

dev-build: ## Build all services for development
	@echo "ğŸ—ï¸  Building all services..."
	docker-compose build --no-cache
	@echo "âœ… Build complete!"

dev-logs: ## Follow logs for all services
	docker-compose logs -f

dev-down: ## Stop all development services
	@echo "ğŸ›‘ Stopping all services..."
	docker-compose down
	@echo "âœ… All services stopped!"

# Production commands
prod-up: ## Start all services in production mode
	@echo "ğŸš€ Starting Cabinet Quoting System in production mode..."
	docker-compose -f docker-compose.yml up -d
	@echo "âœ… Production services started!"

prod-build: ## Build all services for production
	@echo "ğŸ—ï¸  Building production images..."
	docker-compose -f docker-compose.yml build --no-cache
	@echo "âœ… Production build complete!"

prod-logs: ## Follow production logs
	docker-compose -f docker-compose.yml logs -f

prod-down: ## Stop production services
	@echo "ğŸ›‘ Stopping production services..."
	docker-compose -f docker-compose.yml down
	@echo "âœ… Production services stopped!"

# Management commands
restart: ## Restart all services
	@echo "ğŸ”„ Restarting all services..."
	docker-compose restart
	@echo "âœ… Services restarted!"

status: ## Show status of all containers
	@echo "ğŸ“Š Container Status:"
	@echo "==================="
	@docker-compose ps

health: ## Check health of all services
	@echo "ğŸ¥ Health Check Results:"
	@echo "======================="
	@docker-compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}"
	@echo ""
	@echo "Individual Service Health:"
	@echo "-------------------------"
	@docker exec cabinet-frontend curl -s http://localhost:3000/api/health 2>/dev/null && echo "âœ… Frontend: Healthy" || echo "âŒ Frontend: Unhealthy"
	@docker exec cabinet-admin curl -s http://localhost:3001/api/health 2>/dev/null && echo "âœ… Admin: Healthy" || echo "âŒ Admin: Unhealthy"
	@docker exec cabinet-backend curl -s http://localhost:3002/health 2>/dev/null && echo "âœ… Backend: Healthy" || echo "âŒ Backend: Unhealthy"
	@docker exec cabinet-quote-engine curl -s http://localhost:3003/health 2>/dev/null && echo "âœ… Quote Engine: Healthy" || echo "âŒ Quote Engine: Unhealthy"
	@docker exec cabinet-database pg_isready -U cabinet_user -d cabinet_quoting 2>/dev/null && echo "âœ… Database: Healthy" || echo "âŒ Database: Unhealthy"

logs: ## Show logs from specific service (usage: make logs SERVICE=frontend)
	@if [ -z "$(SERVICE)" ]; then \
		echo "âŒ Please specify a service: make logs SERVICE=frontend|admin|backend|quote-engine|database|nginx"; \
	else \
		echo "ğŸ“‹ Logs for $(SERVICE):"; \
		docker-compose logs -f $(SERVICE); \
	fi

shell: ## Open shell in specific service (usage: make shell SERVICE=backend)
	@if [ -z "$(SERVICE)" ]; then \
		echo "âŒ Please specify a service: make shell SERVICE=frontend|admin|backend|quote-engine|database|nginx"; \
	else \
		echo "ğŸš Opening shell in $(SERVICE)..."; \
		docker-compose exec $(SERVICE) sh; \
	fi

# Database commands
db-connect: ## Connect to PostgreSQL database
	@echo "ğŸ—„ï¸  Connecting to database..."
	docker-compose exec database psql -U cabinet_user -d cabinet_quoting

db-backup: ## Backup database
	@echo "ğŸ’¾ Creating database backup..."
	@mkdir -p ./backups
	docker-compose exec database pg_dump -U cabinet_user cabinet_quoting > ./backups/cabinet_quoting_$(shell date +%Y%m%d_%H%M%S).sql
	@echo "âœ… Backup created in ./backups/"

db-restore: ## Restore database (usage: make db-restore BACKUP=filename.sql)
	@if [ -z "$(BACKUP)" ]; then \
		echo "âŒ Please specify backup file: make db-restore BACKUP=filename.sql"; \
	else \
		echo "ğŸ”„ Restoring database from $(BACKUP)..."; \
		docker-compose exec -T database psql -U cabinet_user -d cabinet_quoting < ./backups/$(BACKUP); \
		echo "âœ… Database restored!"; \
	fi

# Cleanup commands
clean: ## Remove stopped containers and unused images
	@echo "ğŸ§¹ Cleaning up..."
	docker-compose down --remove-orphans
	docker container prune -f
	docker image prune -f
	@echo "âœ… Cleanup complete!"

prune: ## Deep clean - remove all unused containers, networks, images
	@echo "ğŸ§¹ Deep cleaning Docker system..."
	@echo "âš ï¸  This will remove ALL unused Docker resources!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo ""; \
		docker system prune -af; \
		docker volume prune -f; \
		echo "âœ… Deep clean complete!"; \
	else \
		echo ""; \
		echo "âŒ Deep clean cancelled."; \
	fi

reset: ## Complete reset - rebuild everything from scratch
	@echo "ğŸ”„ Complete system reset..."
	@echo "âš ï¸  This will destroy all data and rebuild everything!"
	@read -p "Are you sure? [y/N] " -n 1 -r; \
	if [[ $$REPLY =~ ^[Yy]$$ ]]; then \
		echo ""; \
		make clean; \
		docker-compose down -v; \
		docker-compose build --no-cache; \
		docker-compose up -d; \
		echo "âœ… System reset complete!"; \
	else \
		echo ""; \
		echo "âŒ Reset cancelled."; \
	fi

# Development utilities
install: ## Install dependencies in all services
	@echo "ğŸ“¦ Installing dependencies..."
	docker-compose run --rm frontend npm install
	docker-compose run --rm admin-interface npm install
	docker-compose run --rm backend npm install
	docker-compose run --rm quote-engine npm install
	@echo "âœ… Dependencies installed!"

test: ## Run tests in all services
	@echo "ğŸ§ª Running tests..."
	docker-compose run --rm backend npm test
	docker-compose run --rm quote-engine npm test
	@echo "âœ… Tests complete!"

# Monitoring commands
monitor: ## Show real-time container stats
	@echo "ğŸ“Š Real-time container monitoring (press Ctrl+C to stop):"
	docker stats cabinet-frontend cabinet-admin cabinet-backend cabinet-quote-engine cabinet-database cabinet-nginx

urls: ## Show all service URLs
	@echo "ğŸŒ Service URLs:"
	@echo "==============="
	@echo "Frontend (Customer):  http://localhost:3000"
	@echo "Admin Interface:      http://localhost:3001"
	@echo "Backend API:          http://localhost:3002"
	@echo "Quote Engine:         http://localhost:3003"
	@echo "Database:             localhost:5432"
	@echo "Nginx (Main):         http://localhost:80"
	@echo ""
	@echo "API Documentation:    http://localhost:3002/api-docs"
	@echo "Quote API Docs:       http://localhost:3003/api-docs"